<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ED Risk Assessment</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0f172a;--surface:#1e293b;--surface2:#334155;
    --text:#e2e8f0;--text-muted:#94a3b8;--accent:#3b82f6;
    --accent-hover:#2563eb;--green:#22c55e;--yellow:#eab308;
    --red:#ef4444;--orange:#f97316;--radius:12px;
    --font:'Segoe UI',system-ui,-apple-system,sans-serif;
  }
  html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text)}

  /* ── Layout ── */
  .shell{display:flex;flex-direction:column;height:100vh;max-width:900px;margin:0 auto}

  header{
    padding:14px 24px;border-bottom:1px solid var(--surface2);
    display:flex;align-items:center;gap:12px;flex-shrink:0;
  }
  header .logo{
    width:36px;height:36px;border-radius:8px;background:var(--accent);
    display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;
  }
  header h1{font-size:17px;font-weight:600}
  header .status{
    margin-left:auto;display:flex;align-items:center;gap:6px;
    font-size:12px;color:var(--text-muted);
  }
  header .status .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
  header .status .dot.offline{background:var(--red)}

  /* ── Tabs ── */
  .tab-bar{
    display:flex;border-bottom:1px solid var(--surface2);flex-shrink:0;
  }
  .tab-bar button{
    flex:1;padding:10px 0;background:none;border:none;border-bottom:2px solid transparent;
    color:var(--text-muted);font-size:13px;font-weight:600;cursor:pointer;
    font-family:var(--font);transition:all .15s;
  }
  .tab-bar button:hover{color:var(--text)}
  .tab-bar button.active{color:var(--accent);border-bottom-color:var(--accent)}

  .tab-content{flex:1;overflow:hidden;display:none;flex-direction:column}
  .tab-content.active{display:flex}

  /* ── Chat tab ── */
  .messages{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:14px}
  .msg{display:flex;gap:10px;max-width:92%;animation:fadeIn .25s ease}
  .msg.bot{align-self:flex-start}
  .msg.user{align-self:flex-end;flex-direction:row-reverse}
  .msg .avatar{
    width:30px;height:30px;border-radius:8px;flex-shrink:0;
    display:flex;align-items:center;justify-content:center;font-size:13px;
  }
  .msg.bot .avatar{background:var(--accent)}
  .msg.user .avatar{background:var(--surface2)}
  .msg .bubble{
    padding:12px 16px;border-radius:var(--radius);line-height:1.6;font-size:13.5px;word-break:break-word;
  }
  .msg.bot .bubble{background:var(--surface);border:1px solid var(--surface2)}
  .msg.user .bubble{background:var(--accent);color:#fff;white-space:pre-wrap}

  .bubble h3{font-size:14px;font-weight:700;margin:10px 0 4px;color:#fff}
  .bubble h3:first-child{margin-top:0}
  .bubble h4{font-size:13.5px;font-weight:600;margin:8px 0 3px;color:var(--text)}
  .bubble strong{color:#fff}
  .bubble em{color:var(--text-muted);font-style:italic}
  .bubble p{margin:3px 0}
  .bubble ul,.bubble ol{margin:3px 0 3px 18px}
  .bubble li{margin:2px 0}
  .bubble hr{border:none;border-top:1px solid var(--surface2);margin:8px 0}
  .bubble table{border-collapse:collapse;margin:6px 0;width:100%;font-size:12.5px}
  .bubble th,.bubble td{padding:4px 8px;border:1px solid var(--surface2);text-align:left}
  .bubble th{background:var(--surface2);font-weight:600}

  .suggestions{padding:0 24px 10px;display:flex;flex-wrap:wrap;gap:6px}
  .suggestions button{
    padding:5px 12px;border-radius:20px;border:1px solid var(--surface2);
    background:transparent;color:var(--text-muted);font-size:11.5px;
    cursor:pointer;transition:all .15s;font-family:var(--font);
  }
  .suggestions button:hover{border-color:var(--accent);color:var(--accent)}

  .input-area{
    padding:12px 24px;border-top:1px solid var(--surface2);display:flex;gap:8px;flex-shrink:0;
  }
  .input-area input{
    flex:1;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--surface2);
    background:var(--surface);color:var(--text);font-size:13.5px;font-family:var(--font);
    outline:none;transition:border-color .15s;
  }
  .input-area input:focus{border-color:var(--accent)}
  .input-area input::placeholder{color:var(--text-muted)}
  .input-area button{
    padding:10px 18px;border-radius:var(--radius);border:none;
    background:var(--accent);color:#fff;font-size:13.5px;font-weight:600;
    cursor:pointer;transition:background .15s;font-family:var(--font);
  }
  .input-area button:hover{background:var(--accent-hover)}
  .input-area button:disabled{opacity:.5;cursor:not-allowed}

  .typing{display:flex;gap:4px;padding:4px 0}
  .typing span{width:5px;height:5px;border-radius:50%;background:var(--text-muted);animation:bounce .6s infinite alternate}
  .typing span:nth-child(2){animation-delay:.15s}
  .typing span:nth-child(3){animation-delay:.3s}

  /* ── Stats tab ── */
  .stats{flex:1;overflow-y:auto;padding:28px 24px}
  .stats h2{font-size:20px;font-weight:700;margin-bottom:4px}
  .stats .lead{color:var(--text-muted);font-size:14px;margin-bottom:24px}
  .stats h3{font-size:15px;font-weight:600;margin:24px 0 10px;color:#fff}
  .stats p{font-size:14px;line-height:1.6;margin-bottom:10px}

  .region-row{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
  .region-row label{font-size:13px;color:var(--text-muted);font-weight:600}
  .region-row select{
    padding:8px 12px;border-radius:var(--radius);border:1px solid var(--surface2);
    background:var(--surface);color:var(--text);font-size:13px;font-family:var(--font);
    min-width:160px;cursor:pointer;
  }

  .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
  .card{background:var(--surface);border:1px solid var(--surface2);border-radius:var(--radius);padding:16px}
  .card .num{font-size:28px;font-weight:700;color:var(--accent)}
  .card .lbl{font-size:12px;color:var(--text-muted);margin-top:2px}

  .bar-chart{margin:12px 0 20px}
  .bar-row{display:flex;align-items:center;margin-bottom:8px;gap:10px}
  .bar-label{width:170px;font-size:13px;text-align:right;flex-shrink:0;color:var(--text-muted)}
  .bar-track{flex:1;height:22px;background:var(--surface2);border-radius:4px;overflow:hidden;position:relative}
  .bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:11px;font-weight:600;color:#fff;transition:width .5s ease}
  .bar-fill.red{background:var(--red)}
  .bar-fill.orange{background:var(--orange)}
  .bar-fill.yellow{background:var(--yellow)}
  .bar-fill.green{background:var(--green)}
  .bar-fill.blue{background:var(--accent)}

  .bar-row-expand{margin-top:4px;margin-left:180px;padding:10px 12px;background:var(--surface);border:1px solid var(--surface2);border-radius:var(--radius);font-size:12px;color:var(--text-muted);display:none}
  .bar-row-expand.open{display:block}

  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 20px}
  .info-box{background:var(--surface);border:1px solid var(--surface2);border-radius:var(--radius);padding:14px}
  .info-box h4{font-size:13px;font-weight:600;margin-bottom:6px;color:#fff}
  .info-box ul{margin:0 0 0 16px;font-size:13px;color:var(--text-muted)}
  .info-box li{margin:3px 0}

  .fact-strip{display:flex;gap:12px;margin:16px 0;overflow-x:auto}
  .fact{background:var(--surface);border:1px solid var(--surface2);border-radius:var(--radius);padding:14px 18px;min-width:180px;text-align:center}
  .fact .big{font-size:24px;font-weight:700}
  .fact .big.red{color:var(--red)}
  .fact .big.orange{color:var(--orange)}
  .fact .big.green{color:var(--green)}
  .fact .big.blue{color:var(--accent)}
  .fact .sub{font-size:11.5px;color:var(--text-muted);margin-top:2px}

  .stats-loading{color:var(--text-muted);font-size:14px;padding:20px 0}
  .learn-more-btn{background:none;border:none;color:var(--accent);cursor:pointer;font-size:11px;padding:0 4px;font-family:var(--font)}
  .learn-more-btn:hover{text-decoration:underline}

  @media(max-width:600px){
    .info-grid{grid-template-columns:1fr}
    .card-grid{grid-template-columns:1fr 1fr}
  }

  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  @keyframes bounce{to{transform:translateY(-5px);opacity:.4}}
</style>
</head>
<body>
<div class="shell">
  <header>
    <div class="logo">+</div>
    <div><h1>ED Risk Assessment</h1></div>
    <div class="status">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Connecting...</span>
    </div>
  </header>

  <div class="tab-bar">
    <button class="active" onclick="switchTab('chat')">Chat</button>
    <button onclick="switchTab('stats')">Statistics &amp; Info</button>
  </div>

  <!-- ════ CHAT TAB ════ -->
  <div id="tab-chat" class="tab-content active">
    <div class="messages" id="messages"></div>
    <div class="suggestions" id="suggestions">
      <button onclick="send('hello')">Get started</button>
      <button onclick="send('72 year old male with COPD and CHF, temp 101, BP 135/85, pulse 110, pain 8/10')">Example patient</button>
      <button onclick="send('What are the risk factors for ED revisits?')">Risk factors</button>
      <button onclick="send('help')">Help</button>
    </div>
    <div class="input-area">
      <input type="text" id="input" placeholder="Describe a patient or ask a question..." autocomplete="off">
      <button id="sendBtn" onclick="sendFromInput()">Send</button>
    </div>
  </div>

  <!-- ════ STATS TAB ════ -->
  <div id="tab-stats" class="tab-content">
    <div class="stats">
      <h2>Understanding ED Readmissions</h2>
      <p class="lead">Explore readmission and revisit rates from NHAMCS data — by U.S. region and by condition. Use the Chat tab to assess a patient; risk categories there are tied to the conditions you enter.</p>

      <div class="region-row">
        <label for="regionSelect">Show stats for:</label>
        <select id="regionSelect">
          <option value="0">All U.S. (national)</option>
        </select>
      </div>

      <div id="statsCards" class="card-grid">
        <div class="stats-loading">Loading statistics…</div>
      </div>

      <h3>72-Hour ED Revisit &amp; Admission Rates by Condition</h3>
      <p>Rates among patients with each condition in the survey. Click <strong>Learn more</strong> for context.</p>
      <div id="statsBarChart" class="bar-chart"></div>

      <h3>What Makes Someone High-Risk?</h3>
      <div class="info-grid">
        <div class="info-box">
          <h4>Medical Factors</h4>
          <ul>
            <li>Multiple chronic conditions (3+)</li>
            <li>Heart failure, COPD, kidney disease</li>
            <li>Recent hospitalization</li>
            <li>Abnormal vital signs at discharge</li>
            <li>Taking 5+ medications</li>
          </ul>
        </div>
        <div class="info-box">
          <h4>Social &amp; Access Factors</h4>
          <ul>
            <li>No primary care doctor</li>
            <li>Lack of transportation</li>
            <li>Housing instability</li>
            <li>No insurance or underinsured</li>
            <li>Language barriers</li>
          </ul>
        </div>
        <div class="info-box">
          <h4>Behavioral Factors</h4>
          <ul>
            <li>Substance use disorder</li>
            <li>Mental health conditions</li>
            <li>Poor understanding of discharge instructions</li>
            <li>Missed follow-up appointments</li>
            <li>Medication non-adherence</li>
          </ul>
        </div>
        <div class="info-box">
          <h4>Age-Related Factors</h4>
          <ul>
            <li>Adults 65+ have 2× readmission rates</li>
            <li>Cognitive decline and dementia</li>
            <li>Fall risk increases with age</li>
            <li>Children under 5 also elevated risk</li>
            <li>Polypharmacy in elderly</li>
          </ul>
        </div>
      </div>

      <h3>High-Risk Discharge Populations</h3>
      <p>Patients at elevated risk of 72-hour ED revisit need stronger discharge planning.</p>
      <div class="info-box" style="margin-bottom:12px">
        <h4>Structured discharge checklist</h4>
        <ul>
          <li>Diagnosis communicated in plain language</li>
          <li>Medication reconciliation completed</li>
          <li>Follow-up appointment scheduled (PCP within 48–72 hours for high-risk patients)</li>
          <li>Warning signs (“return-if” instructions) in writing</li>
          <li>Transportation and social needs assessed</li>
        </ul>
      </div>
      <div class="info-grid">
        <div class="info-box">
          <h4>Populations at higher risk</h4>
          <ul>
            <li><strong>Elderly (age ≥ 65):</strong> Cognitive screening, fall risk, home safety</li>
            <li><strong>≥ 3 chronic conditions:</strong> Specialist follow-up, medication plan</li>
            <li><strong>Mental health / substance use:</strong> Warm handoff to behavioral health</li>
            <li><strong>Pain:</strong> Opioid alternatives, pain contract if applicable</li>
            <li><strong>Uninsured / underinsured:</strong> Social work, community health center</li>
          </ul>
        </div>
        <div class="info-box">
          <h4>Transitional care interventions</h4>
          <ul>
            <li>Nurse follow-up call within 48h (strong evidence)</li>
            <li>Pharmacist-led med reconciliation for polypharmacy</li>
            <li>Home health referral for elderly with limitations</li>
            <li>Patient navigator / CHW for social barriers</li>
          </ul>
        </div>
      </div>

      <h3>Quick Facts</h3>
      <div class="fact-strip">
        <div class="fact"><div class="big red" id="factChf">—</div><div class="sub">CHF 30-day readmission (lit.)</div></div>
        <div class="fact"><div class="big orange">72 hrs</div><div class="sub">critical window for ED revisit risk</div></div>
        <div class="fact"><div class="big green">40%</div><div class="sub">of readmissions potentially preventable</div></div>
        <div class="fact"><div class="big blue">48 hrs</div><div class="sub">follow-up window for high-risk patients</div></div>
      </div>

      <h3>How This Tool Works</h3>
      <p>This tool uses a <strong>machine learning model</strong> trained on <strong>NHAMCS</strong> (National Hospital Ambulatory Medical Care Survey) — a nationally representative survey of U.S. ED visits. In the <strong>Chat</strong> tab, when you describe a patient, risk categories and recommendations are based on the <strong>conditions you enter</strong> (e.g. COPD, CHF) so you see only relevant stats.</p>
      <p style="margin-top:12px;color:var(--text-muted);font-size:13px">
        <em>For educational and informational purposes only. Not a substitute for professional medical judgment.</em>
      </p>
    </div>
  </div>
</div>

<script>
/* ── Tab switching ── */
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  document.querySelector(`.tab-bar button[onclick="switchTab('${id}')"]`).classList.add('active');
  if (id === 'chat') inputEl.focus();
}

/* ── Markdown renderer ── */
function renderMarkdown(text) {
  let html = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const lines = html.split('\n'), out = [];
  let inTable = false, inList = false;

  for (let i = 0; i < lines.length; i++) {
    let line = lines[i];

    if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
      const cells = line.split('|').filter((_,idx,arr) => idx > 0 && idx < arr.length-1);
      if (cells.every(c => /^[\s\-:]+$/.test(c))) continue;
      if (!inTable) { out.push('<table>'); inTable = true; }
      const isHeader = !out.some(l => l.includes('<td>')) && inTable;
      const tag = isHeader ? 'th' : 'td';
      out.push('<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>');
      continue;
    }
    if (inTable) { out.push('</table>'); inTable = false; }

    if (line.startsWith('### ')) { if (inList){out.push('</ul>');inList=false;} out.push('<h4>'+applyInline(line.slice(4))+'</h4>'); continue; }
    if (line.startsWith('## '))  { if (inList){out.push('</ul>');inList=false;} out.push('<h4>'+applyInline(line.slice(3))+'</h4>'); continue; }
    if (line.startsWith('# '))   { if (inList){out.push('</ul>');inList=false;} out.push('<h3>'+applyInline(line.slice(2))+'</h3>'); continue; }

    if (/^-{3,}$/.test(line.trim())) { if (inList){out.push('</ul>');inList=false;} out.push('<hr>'); continue; }

    if (/^\s*[-•]\s+/.test(line)) {
      if (!inList) { out.push('<ul>'); inList = true; }
      out.push('<li>'+applyInline(line.replace(/^\s*[-•]\s+/,''))+'</li>');
      continue;
    }
    if (/^\s*\d+\.\s+/.test(line)) {
      if (!inList) { out.push('<ul>'); inList = true; }
      out.push('<li>'+applyInline(line.replace(/^\s*\d+\.\s+/,''))+'</li>');
      continue;
    }
    if (inList) { out.push('</ul>'); inList = false; }

    if (line.trim() === '') continue;
    out.push('<p>'+applyInline(line)+'</p>');
  }
  if (inTable) out.push('</table>');
  if (inList) out.push('</ul>');
  return out.join('');
}

function applyInline(t) {
  return t
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code>$1</code>');
}

/* ── Chat logic ── */
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const suggestionsEl = document.getElementById('suggestions');

let sessionId = null, sending = false;

function addMessage(text, role) {
  const wrap = document.createElement('div'); wrap.className = 'msg ' + role;
  const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = role === 'bot' ? '+' : 'U';
  const bubble = document.createElement('div'); bubble.className = 'bubble';
  if (role === 'bot') bubble.innerHTML = renderMarkdown(text);
  else bubble.textContent = text;
  wrap.appendChild(avatar); wrap.appendChild(bubble);
  messagesEl.appendChild(wrap); messagesEl.scrollTop = messagesEl.scrollHeight;
}

function addTyping() {
  const w = document.createElement('div'); w.className = 'msg bot'; w.id = 'typing';
  w.innerHTML = '<div class="avatar">+</div><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  messagesEl.appendChild(w); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function removeTyping() { const e = document.getElementById('typing'); if (e) e.remove(); }

async function send(text) {
  if (sending || !text.trim()) return;
  sending = true; sendBtn.disabled = true; inputEl.value = '';
  suggestionsEl.style.display = 'none';
  switchTab('chat');
  addMessage(text, 'user'); addTyping();
  try {
    const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message:text,session_id:sessionId}) });
    const data = await res.json(); sessionId = data.session_id;
    removeTyping(); addMessage(data.reply, 'bot');
  } catch { removeTyping(); addMessage('Connection error. Is the server running?', 'bot'); }
  sending = false; sendBtn.disabled = false; inputEl.focus();
}
function sendFromInput() { send(inputEl.value); }
inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') sendFromInput(); });

(async function checkHealth() {
  try {
    const r = await fetch('/health'), d = await r.json();
    if (d.status === 'ok') { statusDot.className='dot'; statusText.textContent='Model loaded'; }
    else { statusDot.className='dot offline'; statusText.textContent='Degraded'; }
  } catch { statusDot.className='dot offline'; statusText.textContent='Offline'; }
})();

/* ─── Stats tab: fetch /stats, region selector, data-driven charts ─── */
let statsData = null;
const conditionLearnMore = {
  'CHF': 'Heart failure is a leading cause of 30-day readmission. Daily weights, sodium restriction, and early follow-up reduce risk.',
  'COPD': 'COPD exacerbations often lead to return visits. Ensure inhaler technique and a written action plan at discharge.',
  'CKD': 'Kidney disease increases readmission risk. Monitor electrolytes and coordinate with nephrology.',
  'ESRD': 'Dialysis patients have high ED utilization. Access issues and infection are common drivers of revisit.',
  'CAD': 'Coronary disease may need stress testing or cardiology follow-up before discharge.',
  'ASTHMA': 'Asthma revisits can be reduced with controller medications and trigger education.',
  'HTN': 'Hypertension alone is a moderate risk factor; risk rises with other conditions.',
  'DIABTYP1': 'Type 1 diabetes: hypo- and hyperglycemia drive many ED returns. Review insulin regimen at discharge.',
  'DIABTYP2': 'Type 2 diabetes: ensure glucometer access and follow-up with primary care or diabetes educator.',
  'DIABTYP0': 'Diabetes: medication adherence and follow-up are key to reducing readmissions.',
  'CANCER': 'Cancer patients often have complex care needs; coordination with oncology is important.',
  'CEBVD': 'Stroke and cerebrovascular disease need close follow-up and secondary prevention.',
  'DEPRN': 'Depression is associated with higher readmission; screen and refer when appropriate.',
  'ALZHD': 'Dementia increases fall and medication-related readmission risk.',
  'SUBSTAB': 'Substance use disorder is linked to frequent ED use; warm handoff to treatment can help.',
  'INJURY': 'Injury-related visits may return for wound care or pain; clear instructions reduce revisit.'
};

async function loadStats() {
  if (statsData) return statsData;
  try {
    const r = await fetch('/stats');
    statsData = await r.json();
    return statsData;
  } catch (e) {
    console.warn('Stats load failed', e);
    return { regions: [], conditions: [], national: {} };
  }
}

function barColor(pct) {
  if (pct >= 15) return 'red';
  if (pct >= 10) return 'orange';
  if (pct >= 6) return 'yellow';
  if (pct >= 3) return 'green';
  return 'blue';
}

function renderStatsCards(regionId) {
  const c = document.getElementById('statsCards');
  if (!c) return;
  const national = statsData?.national || {};
  const regions = statsData?.regions || [];
  const r = regionId === 0 || !regionId ? national : regions.find(x => x.id === regionId) || national;
  const label = regionId === 0 || !regionId ? 'U.S.' : (regions.find(x => x.id === regionId)?.name || 'U.S.');
  const n = r.n_visits != null ? r.n_visits : national.n_visits;
  const p72 = r.pct_72h_revisit != null ? r.pct_72h_revisit : national.pct_72h_revisit;
  const pAdm = r.pct_admitted != null ? r.pct_admitted : national.pct_admitted;
  c.innerHTML = ''
    + '<div class="card"><div class="num">' + (n != null ? n.toLocaleString() : '—') + '</div><div class="lbl">ED visits in sample (' + label + ')</div></div>'
    + '<div class="card"><div class="num">' + (p72 != null ? p72 + '%' : '—') + '</div><div class="lbl">72-hour ED revisit rate</div></div>'
    + '<div class="card"><div class="num">' + (pAdm != null ? pAdm + '%' : '—') + '</div><div class="lbl">Admitted to hospital</div></div>'
    + '<div class="card"><div class="num">' + (national.n_visits != null ? national.n_visits.toLocaleString() : '—') + '</div><div class="lbl">National sample size (NHAMCS)</div></div>';
}

function renderStatsBars() {
  const el = document.getElementById('statsBarChart');
  if (!el || !statsData?.conditions?.length) {
    if (el) el.innerHTML = '<p class="stats-loading">No condition data available. Run the pipeline to build stats.</p>';
    return;
  }
  const maxPct = Math.max(...statsData.conditions.map(x => x.pct_72h_revisit), 1);
  let html = '';
  statsData.conditions.forEach((cond, i) => {
    const pct = cond.pct_72h_revisit;
    const w = Math.max(5, (pct / maxPct) * 100);
    const color = barColor(pct);
    const id = 'learn-' + cond.id.replace(/\W/g, '_');
    const desc = conditionLearnMore[cond.id] || 'Condition-specific revisit and admission rates from NHAMCS data.';
    html += '<div class="bar-row">'
      + '<span class="bar-label">' + cond.name + '</span>'
      + '<div class="bar-track"><div class="bar-fill ' + color + '" style="width:' + w + '%">' + pct + '%</div></div>'
      + ' <button type="button" class="learn-more-btn" onclick="toggleLearn(\'' + id + '\')">Learn more</button>'
      + '</div>'
      + '<div id="' + id + '" class="bar-row-expand">' + desc + '</div>';
  });
  el.innerHTML = html;
}

function toggleLearn(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

window.toggleLearn = toggleLearn;

function onRegionChange() {
  const sel = document.getElementById('regionSelect');
  const v = sel ? parseInt(sel.value, 10) : 0;
  renderStatsCards(v);
}

async function initStatsTab() {
  statsData = await loadStats();
  const sel = document.getElementById('regionSelect');
  if (sel && statsData.regions?.length) {
    sel.innerHTML = '<option value="0">All U.S. (national)</option>'
      + statsData.regions.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('');
    sel.addEventListener('change', onRegionChange);
  }
  renderStatsCards(0);
  renderStatsBars();
  const chf = statsData.conditions?.find(c => c.id === 'CHF');
  const factChf = document.getElementById('factChf');
  if (factChf && chf) factChf.textContent = chf.pct_admitted + '%';
}

document.querySelector('.tab-bar button[onclick="switchTab(\'stats\')"]')?.addEventListener('click', function onStatsClick() {
  setTimeout(initStatsTab, 50);
});

inputEl.focus();
</script>
</body>
</html>
