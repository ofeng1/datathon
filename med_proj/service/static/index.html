<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ED Risk Chatbot</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0f172a;--surface:#1e293b;--surface2:#334155;
    --text:#e2e8f0;--text-muted:#94a3b8;--accent:#3b82f6;
    --accent-hover:#2563eb;--green:#22c55e;--yellow:#eab308;
    --red:#ef4444;--radius:12px;--font:'Segoe UI',system-ui,-apple-system,sans-serif;
  }
  html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text)}

  .app{display:flex;flex-direction:column;height:100vh;max-width:820px;margin:0 auto}

  header{
    padding:16px 24px;border-bottom:1px solid var(--surface2);
    display:flex;align-items:center;gap:12px;
  }
  header .logo{
    width:40px;height:40px;border-radius:10px;background:var(--accent);
    display:flex;align-items:center;justify-content:center;font-size:20px;
    flex-shrink:0;
  }
  header h1{font-size:18px;font-weight:600}
  header .subtitle{font-size:13px;color:var(--text-muted)}
  header .status{
    margin-left:auto;display:flex;align-items:center;gap:6px;
    font-size:12px;color:var(--text-muted);
  }
  header .status .dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
  header .status .dot.offline{background:var(--red)}

  .messages{
    flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px;
  }

  .msg{display:flex;gap:12px;max-width:90%;animation:fadeIn .25s ease}
  .msg.bot{align-self:flex-start}
  .msg.user{align-self:flex-end;flex-direction:row-reverse}

  .msg .avatar{
    width:32px;height:32px;border-radius:8px;flex-shrink:0;
    display:flex;align-items:center;justify-content:center;font-size:14px;
  }
  .msg.bot .avatar{background:var(--accent)}
  .msg.user .avatar{background:var(--surface2)}

  .msg .bubble{
    padding:12px 16px;border-radius:var(--radius);line-height:1.55;
    font-size:14px;white-space:pre-wrap;word-break:break-word;
  }
  .msg.bot .bubble{background:var(--surface);border:1px solid var(--surface2)}
  .msg.user .bubble{background:var(--accent);color:#fff}

  .input-area{
    padding:16px 24px;border-top:1px solid var(--surface2);
    display:flex;gap:10px;
  }
  .input-area input{
    flex:1;padding:12px 16px;border-radius:var(--radius);border:1px solid var(--surface2);
    background:var(--surface);color:var(--text);font-size:14px;font-family:var(--font);
    outline:none;transition:border-color .15s;
  }
  .input-area input:focus{border-color:var(--accent)}
  .input-area input::placeholder{color:var(--text-muted)}

  .input-area button{
    padding:12px 20px;border-radius:var(--radius);border:none;
    background:var(--accent);color:#fff;font-size:14px;font-weight:600;
    cursor:pointer;transition:background .15s;font-family:var(--font);
  }
  .input-area button:hover{background:var(--accent-hover)}
  .input-area button:disabled{opacity:.5;cursor:not-allowed}

  .suggestions{
    padding:0 24px 12px;display:flex;flex-wrap:wrap;gap:8px;
  }
  .suggestions button{
    padding:6px 14px;border-radius:20px;border:1px solid var(--surface2);
    background:transparent;color:var(--text-muted);font-size:12px;
    cursor:pointer;transition:all .15s;font-family:var(--font);
  }
  .suggestions button:hover{border-color:var(--accent);color:var(--accent)}

  .typing{display:flex;gap:4px;padding:4px 0}
  .typing span{
    width:6px;height:6px;border-radius:50%;background:var(--text-muted);
    animation:bounce .6s infinite alternate;
  }
  .typing span:nth-child(2){animation-delay:.15s}
  .typing span:nth-child(3){animation-delay:.3s}

  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  @keyframes bounce{to{transform:translateY(-6px);opacity:.4}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">+</div>
    <div>
      <h1>ED Risk Chatbot</h1>
      <div class="subtitle">Describe a patient. Get risk predictions and clinical recommendations.</div>
    </div>
    <div class="status">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Connecting...</span>
    </div>
  </header>

  <div class="messages" id="messages"></div>

  <div class="suggestions" id="suggestions">
    <button onclick="send('hello')">Get started</button>
    <button onclick="send('72 year old male, temp 101, BP 135/85, pulse 110, pain 8/10, 3 chronic conditions')">Example patient</button>
    <button onclick="send('What are the risk factors for ED revisits?')">Risk factors</button>
    <button onclick="send('help')">Help</button>
  </div>

  <div class="input-area">
    <input type="text" id="input" placeholder="Describe a patient or ask a question..." autocomplete="off">
    <button id="sendBtn" onclick="sendFromInput()">Send</button>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const statusDot = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');
const suggestionsEl = document.getElementById('suggestions');

let sessionId = null;
let sending = false;

function addMessage(text, role) {
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + role;
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'bot' ? '+' : 'U';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return wrap;
}

function addTyping() {
  const wrap = document.createElement('div');
  wrap.className = 'msg bot';
  wrap.id = 'typing';
  wrap.innerHTML = '<div class="avatar">+</div><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function removeTyping() {
  const el = document.getElementById('typing');
  if (el) el.remove();
}

async function send(text) {
  if (sending || !text.trim()) return;
  sending = true;
  sendBtn.disabled = true;
  inputEl.value = '';
  suggestionsEl.style.display = 'none';

  addMessage(text, 'user');
  addTyping();

  try {
    const res = await fetch('/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: text, session_id: sessionId}),
    });
    const data = await res.json();
    sessionId = data.session_id;
    removeTyping();
    addMessage(data.reply, 'bot');
  } catch (e) {
    removeTyping();
    addMessage('Connection error. Is the server running?', 'bot');
  }
  sending = false;
  sendBtn.disabled = false;
  inputEl.focus();
}

function sendFromInput() {
  send(inputEl.value);
}

inputEl.addEventListener('keydown', e => {
  if (e.key === 'Enter') sendFromInput();
});

(async function checkHealth() {
  try {
    const res = await fetch('/health');
    const data = await res.json();
    if (data.status === 'ok') {
      statusDot.className = 'dot';
      statusText.textContent = data.models_loaded.length + ' models loaded';
    } else {
      statusDot.className = 'dot offline';
      statusText.textContent = 'Degraded';
    }
  } catch {
    statusDot.className = 'dot offline';
    statusText.textContent = 'Offline';
  }
})();

inputEl.focus();
</script>
</body>
</html>
